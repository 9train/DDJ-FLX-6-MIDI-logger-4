<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Viewer (SOP‑fixed)</title>
    <!-- Fix 404: embed a tiny favicon to stop network error noise -->
    <link rel="icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAGAAAAAAAAAMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" />
    <style>
      :root { color-scheme: light dark; }
      *{ box-sizing: border-box; }
      body{ margin:0; font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
      .toolbar{ position:sticky; top:0; z-index:10; display:flex; flex-wrap:wrap; gap:.5rem; align-items:center; padding:.5rem .75rem; border-bottom:1px solid #ddd; background:#fff; }
      .toolbar button{ padding:.4rem .7rem; border:1px solid #ccc; border-radius:.5rem; background:#f7f7f7; cursor:pointer; }
      .toolbar button:active{ transform:translateY(1px); }
      .spacer{ flex:1 1 auto; }
      .status{ display:flex; gap:1rem; opacity:.8; }
      #boardHost{ width:100vw; height:calc(100dvh - 48px); display:grid; place-items:center; background:#111; color:#fff; }
      #boardHost.fill svg, #boardHost.fill canvas, #boardHost.fill img{ width:100%; height:100%; object-fit:contain; }
      body.transparent{ background:transparent; }
      /* optional: demonstrate jog targets if present */
      [id^="jog_"]{ transition: transform .05s linear; }
    </style>
  </head>
  <body>
    <div class="toolbar">
      <button id="fit"      title="Fit to window">Fit</button>
      <button id="fill"     title="Fill window">Fill</button>
      <button id="toggleBG" title="Toggle transparent background">Toggle BG</button>
      <div class="spacer"></div>
      <div class="status">
        <span id="wsStatus">WS: ⏳</span>
        <span>MIDI: viewer</span>
      </div>
      <button id="recStop" title="Stop playback">Stop</button>
      <button id="recPlay" title="Play">Play</button>
      <label title="Load recording">
        <input id="recLoad" type="file" accept=".json,.txt" />
      </label>
    </div>

    <!-- Stage / board host that the launcher will mount into or manipulate -->
    <div id="boardHost" class="fill">
      <!-- Your SVG / Canvas / Visuals mount here. If your SVG contains
           elements with ids `jog_L` and `jog_R`, the Jog Physics below
           will rotate them when Tape Mode is enabled upstream. -->
    </div>

    <!-- IMPORTANT: type="module" so top‑level await + ESM works;
         without this the browser renders code as text and fails. -->
    <script type="module">
      /* ==========================
       * viewer.html (SOP‑fixed)
       * ==========================
       * SOP RULES APPLIED:
       * - No functionality removed; only guards and path fixes added.
       * - All original features preserved: status helper, recorder controls,
       *   launcher init + scrub, Jog Physics, theme hotkey.
       * - Absolute imports changed to RELATIVE to avoid HTML‑as‑JS errors.
       */

      // Convenience selector
      const $ = (id) => document.getElementById(id);

      // Status helper (unchanged)
      const wsStatusEl = $("wsStatus");
      window.setWSStatus = (s) => { if (wsStatusEl) wsStatusEl.textContent = "WS: " + s; };

      // Recorder: Load / Play / Stop only (viewer)
      try {
        // FIX: Use relative path so deployments under a subpath don't 404 and return HTML
        const { recorder: FLXRec } = await import('./src/recorder.js');
        window.recorder = FLXRec;
        $("recStop")?.addEventListener('click', () => FLXRec.stop());
        $("recPlay")?.addEventListener('click', () => FLXRec.play({ speed: 1.0, loop: false }));
        $("recLoad")?.addEventListener('change', async (e) => {
          const file = e.target.files?.[0];
          if (!file) return;
          const text = await file.text();
          await FLXRec.loadFromText(text);
        });
      } catch (e) {
        console.warn('[viewer] recorder unavailable', e);
      }

      // Toolbar actions (unchanged)
      const stage = document.getElementById('boardHost');
      $("fit") ?.addEventListener('click', () => stage?.classList.remove('fill'));
      $("fill") ?.addEventListener('click', () => stage?.classList.add('fill'));
      $("toggleBG")?.addEventListener('click', () => document.body.classList.toggle('transparent'));

      // Minimal launcher + scrub of any host leftovers (unchanged behavior; stronger guards)
      try {
        // FIX: Relative import to avoid HTML‑as‑JS
        const { initLauncher } = await import('./src/launcher.js');
        const launcher = initLauncher({
          actions: {
            toggleTheme: () => (window.THEME?.toggle?.()),
            fit:  () => stage?.classList.remove('fill'),
            fill: () => stage?.classList.add('fill'),
            toggleBG: () => document.body.classList.toggle('transparent'),
          },
          mountPresetUI: () => {},
        });

        const kill = (sel) => document.querySelectorAll(sel).forEach(el => el.remove());
        kill('#launcher .section-panels, .launcher .section-panels');
        kill('#launcher .section--presets, .launcher .section--presets, #launcher .section-presets, .launcher .section-presets');
        kill('[data-action="toggleDiag"], [data-action="toggleTimeline"], [data-action="toggleWizard"], [data-action="toggleEdit"]');
        Array.from(document.querySelectorAll('#launcher button, .launcher button')).forEach(btn=>{
          const t = (btn.textContent || '').trim().toLowerCase();
          if (t === 'rec' || t === 'save') btn.remove();
        });
        Array.from(document.querySelectorAll('#launcher h2, .launcher h2')).forEach(h=>{
          if ((h.textContent||'').trim().toLowerCase()==='presets') h.remove();
        });
      } catch (e) {
        console.warn('[viewer] launcher unavailable', e);
      }

      // Jog Physics ("Tape Mode") — preserved
      const Jog = (() => {
        const CFG = { mode:'off', sensitivity:2.5, damping:0.92 };
        const S = {
          L:{ angle:0, vel:0, lastVal:null, lastKey:null, el:null },
          R:{ angle:0, vel:0, lastVal:null, lastKey:null, el:null },
          anim:null
        };

        function toIdVariants(id){
          const v=String(id||'');
          const a=new Set([v]);
          if (v.includes('_x5F_')) a.add(v.replace(/_x5F_/g,'_'));
          if (v.includes('_')) a.add(v.replace(/_/g,'_x5F_'));
          return [...a];
        }
        function getEl(id){
          for (const vid of toIdVariants(id)) {
            const el = document.getElementById(vid);
            if (el) return el;
          }
          return null;
        }
        function resolveJogEls(){
          S.L.el=getEl('jog_L');
          S.R.el=getEl('jog_R');
        }
        resolveJogEls();

        function applyRotation(el, ang){
          if (!el) return;
          try { el.style.transformBox = 'fill-box'; el.style.transformOrigin = 'center'; el.style.transform = `rotate(${ang}deg)`; } catch {}
          try {
            const bb=el.getBBox();
            const cx=bb.x+bb.width/2, cy=bb.y+bb.height/2;
            el.setAttribute('transform', `rotate(${ang} ${cx} ${cy})`);
          } catch {}
        }

        function tick(){
          S.anim = requestAnimationFrame(tick);
          if (CFG.mode !== 'tape') return;
          ['L','R'].forEach(side=>{
            const j=S[side];
            if (!j.el) return;
            j.angle += j.vel;
            j.vel *= CFG.damping;
            if (Math.abs(j.vel) < 0.001) j.vel = 0;
            applyRotation(j.el, j.angle);
          });
        }

        if (!window.__JOG_WRAP__) {
          window.__JOG_WRAP__ = true;
          const orig = window.consumeInfo;
          // FIX: Guard original handler so undefined doesn't crash
          window.consumeInfo = (info) => {
            try { onEvent(info); } catch {}
            if (typeof orig === 'function') return orig(info);
            return undefined;
          };
        }

        function onEvent(info){
          if (CFG.mode === 'off') return;
          const mm = window.getUnifiedMap?.() || [];
          const type = (info.type||'').toLowerCase();
          const code = type === 'cc' ? (info.controller ?? info.d1) : info.d1;
          const key = `${type}:${info.ch}:${code}`;

          const hits = mm.filter(m =>
            (m.key && m.key === key && m.target) ||
            (!m.key && m.type === type && m.ch === info.ch && m.code === (info.controller ?? info.d1) && m.target)
          );

          let side = null;
          if (hits.some(h => (h.target||'').toLowerCase().includes('jog_l'))) side = 'L';
          if (hits.some(h => (h.target||'').toLowerCase().includes('jog_r'))) side = side || 'R';
          if (!side) return;

          const j = S[side];
          if (!j.el) resolveJogEls();

          if (CFG.mode === 'absolute') {
            const angle = (info.value ?? info.d2 ?? 0) * (360/127);
            j.angle = angle;
            applyRotation(j.el, j.angle);
            return;
          }

          if (CFG.mode === 'tape') {
            const v = (info.value ?? info.d2 ?? 0) | 0;
            if (j.lastKey !== key) j.lastVal = null;
            let d;
            if (j.lastVal == null) d = 0; else {
              d = v - j.lastVal;
              if (d > 64) d -= 128;
              if (d < -64) d += 128;
            }
            j.lastVal = v;
            j.lastKey = key;
            j.vel += d * 2.5;
            if (!S.anim) tick();
          }
        }

        return { CFG, S, applyRotation };
      })();

      // Hotkey: Shift+T toggles theme (guarded)
      document.addEventListener('keydown', (e)=>{
        if (e.shiftKey && e.key.toLowerCase()==='t') window.THEME?.toggle?.();
      });
    </script>
  </body>
</html>
